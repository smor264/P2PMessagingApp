<html>
<head>
	<link href="static/style.css" rel="stylesheet">
	<script src="jquery-3.3.1.min.js"></script>
</head>
<header>
	<script>
	var currentRecipient = "None"
	
	function getCurrentChat() {		
	url = "/currentChat";
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
				currentRecipient = xmlhttp.responseText;
				}	
		};
	xmlhttp.open("GET", url, true);
	xmlhttp.send();
	};
	
	function httpGetAsync(){
		url = "/updateUserList?parameter=username";
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
				console.log(xmlhttp.responseText);
				document.getElementById("username").innerHTML = xmlhttp.responseText;
				}	
		};
	xmlhttp.open("GET", url, true);
	xmlhttp.send();
	ptc(currentRecipient);
	pullMessages(currentRecipient);
	};
	
	function pullMessages(sender){
		currentRecipient = sender;
		url = "/inbox?sender="+sender;
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.onreadystatechange = function() {
			if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
				//console.log(xmlhttp.responseText);
				document.getElementById("main").innerHTML = xmlhttp.responseText;
				}	
		};
	xmlhttp.open("GET", url, true);
	xmlhttp.send();
	};
	
	window.onload = getCurrentChat;
	window.onload = httpGetAsync;

	setInterval(httpGetAsync,5000);
	setInterval(getCurrentChat,5000);
	//var refreshMessages = pullMessages(currentRecipient);
	//setInterval(refreshMessages,5000);
	//var foofunc = foo;
	//setInterval(foofunc,500);
	function ptc(thing) {
		console.log(thing);
	}
	
	window.onunload = WindowCloseHandler;
	function WindowCloseHandler() {
	url = "/signout"
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.open("GET", url, true);
	xmlhttp.send();
	};
	
		window.onload=function() {
	var textin = document.getElementById("submitMessage");
	textin.addEventListener("keydown", function(e){
		var key = e.which || e.keyCode;
		if(key == 13) {
			sendMessage();
		}
	});
	}
	
	function sendMessage() {
	message = document.getElementById("messageText").value;
	url = "/sendMessage?message="+message;
	ptc("1");
	var xmlhttp = new XMLHttpRequest();
	xmlhttp.onreadystatechange = function() {
		if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
			console.log(xmlhttp.responseText);
			document.getElementById("messageText") = " ";
			}
	};
	xmlhttp.open("POST", url, true);
	xmlhttp.send(message);
	};
	
	</script>
<title>Welcome!</title>
</header>
	<body>
		<div class= "titletext">
			<h1> Main </h1>
			<form>
				<input type="submit" value="signout" action="/signout" method="post">
			</form>
		</div>
		<div class= "bodytext">
			Successfully logged in! <br/><br/>
			Click on a user to start chatting <br/>
			<p id="main"></p>
			
		</div>
		<div class= "chatbox">
			<form id="submitMessage">
			<textarea id="messageText" name="message" rows='5' cols='100'></textarea>
			<input type="button" value="Send Message">
			</form>
			
			<form id="attachFile" method="post" action="/sendFile" enctype="multipart/form-data">
			Send File: <input type="file" name='myFile' maxlength=50 allow="media_type">
			<input type="submit">
			</form>
		</div>
		<div class= "sidebar">
			Current online users:
			<aside id="username"></aside>
		</div>
	</body>
	<footer>

	</footer>
</html>	
